<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä½œæ¥­ã‚¿ã‚¤ãƒãƒ¼ & é›†è¨ˆï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆ/å‰Šé™¤å¯¾å¿œï¼‰</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #334155;
      --text: #e5e7eb;
      --accent: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --border: #1f2937;
    }
    html, body { height: 100%; }
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial; background: var(--bg); color: var(--text);} 
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    .nav { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .tabbtn { border: 1px solid var(--border); background: var(--card); color: var(--text); padding: 12px; border-radius: 12px; font-weight: 600; }
    .tabbtn.active { outline: 2px solid var(--accent); }
    .card { border: 1px solid var(--border); background: var(--card); border-radius: 16px; padding: 16px; }
    h1 { font-size: 20px; margin: 8px 0 12px; }
    label { display: block; font-size: 14px; margin: 10px 0 4px; color: #cbd5e1; }
    input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: #0b1220; color: var(--text); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btnbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0b1220; color: var(--text); font-weight: 600; }
    button.primary { background: var(--accent); color: #052e16; border-color: #16a34a; }
    button.warn { background: var(--warn); color: #1f1300; border-color: #b45309; }
    button.danger { background: var(--danger); color: #2f0b0b; border-color: #b91c1c; }
    .inline { display:flex; gap:8px; align-items:center; }
    .timer { font-variant-numeric: tabular-nums; font-size: 40px; letter-spacing: 1px; text-align: center; padding: 12px; border: 1px dashed var(--muted); border-radius: 12px; margin-top: 8px; background: #0b1220; }
    .muted { color: #94a3b8; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px; text-align: left; font-size: 14px; }
    th { color: #cbd5e1; }
    .right { text-align: right; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #0b1220; border: 1px solid var(--border); font-size: 12px; color: #cbd5e1; }
    .footer { margin-top: 20px; font-size: 12px; color: #9ca3af; }
  </style>
  <script>
    // ====== Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºï¼ˆè¨­å®šå¿…é ˆï¼‰ ======
    // Webã‚¢ãƒ—ãƒªå…¬é–‹URLã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: https://script.google.com/macros/s/AKfycbx.../execï¼‰
    const CLOUD_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwHXAYPIK2B5KDCxQvE5eGaIQdpnwwoU6IpauM3onBQ3Fvx1i8O8BGVJQVW1efvkOI8WA/exec';
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆApps Script å´ã® doPost ã§æ¤œè¨¼ã—ã¾ã™ï¼‰
    const CLOUD_TOKEN = 'tAkeshi_2025_WorkTimer_SECRET_9xQ';
  </script>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <button class="tabbtn active" id="tabTimerBtn">â± ä½œæ¥­ã‚¿ã‚¤ãƒãƒ¼</button>
      <button class="tabbtn" id="tabSummaryBtn">ğŸ“Š é›†è¨ˆï¼ˆæœ¬æ—¥/æ—¥ä»˜æŒ‡å®šï¼‰</button>
    </div>

    <!-- Timer Panel -->
    <section id="panelTimer" class="card">
      <h1>â± ä½œæ¥­ã‚¿ã‚¤ãƒãƒ¼</h1>
      <div class="row">
        <div>
          <label for="taskName">ä½œæ¥­é …ç›® <span class="muted">ï¼ˆä¾‹ï¼šæ¤œæŸ» / åˆæœŸåŒ– / æ¸…æƒï¼‰</span></label>
          <div class="inline">
            <input id="taskName" placeholder="ä¾‹ï¼šæ¤œæŸ»" list="taskPresets" />
            <button id="btnAddPreset" title="ç¾åœ¨ã®ä½œæ¥­é …ç›®ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆç™»éŒ²">â˜† è¿½åŠ </button>
          </div>
          <datalist id="taskPresets"></datalist>
          <div class="muted">â€» ã‚ˆãä½¿ã†ä½œæ¥­ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆç™»éŒ²ã§ãã¾ã™ã€‚</div>
        </div>
        <div>
          <label for="taskAmount">ä½œæ¥­å°æ•°</label>
          <input id="taskAmount" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š11" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="worker">ä½œæ¥­æ‹…å½“è€…</label>
          <input id="worker" placeholder="æ°åï¼ˆæ¬¡å›ä»¥é™ã¯è‡ªå‹•å…¥åŠ›ï¼‰" />
        </div>
        <div>
          <label for="notes">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <input id="notes" placeholder="ãƒˆãƒ©ãƒ–ãƒ«ãƒ»å‚™è€ƒãªã©" />
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="btnStart">ä½œæ¥­é–‹å§‹</button>
        <button id="btnPause" style="display:none">â¸ ä½œæ¥­ä¸­æ–­</button>
        <button class="warn" id="btnResume" style="display:none">â–¶ ä½œæ¥­å†é–‹</button>
        <button class="danger" id="btnFinish" style="display:none">âœ… ä½œæ¥­å®Œäº†</button>
        <button id="btnReset" style="display:none">ğŸ—‘ ç ´æ£„</button>
      </div>

      <div class="timer" id="timerDisplay">00:00:00</div>
      <div class="muted" id="statusLine">å¾…æ©Ÿä¸­</div>
      <div class="muted" style="margin-top:8px">â€» é›†è¨ˆç”»é¢ã¯ URL ã®æœ«å°¾ã« <code>#summary</code> ã‚’ä»˜ã‘ã¦é–‹ã‘ã¾ã™ã€‚</div>
    </section>

    <!-- Summary Panel -->
    <section id="panelSummary" class="card" style="display:none">
      <h1>ğŸ“Š é›†è¨ˆï¼ˆå‰Šé™¤å¯¾å¿œï¼‰</h1>
      <div class="row">
        <div>
          <label for="datePick">å¯¾è±¡æ—¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜åˆ†ï¼‰</label>
          <input id="datePick" type="date" />
        </div>
        <div>
          <label>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</label>
          <div class="btnbar">
            <button id="btnCsv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button id="btnClearDay" class="danger">ã“ã®æ—¥ã®è¨˜éŒ²ã‚’å‰Šé™¤</button>
          </div>
        </div>
      </div>

      <div style="overflow:auto; margin-top: 10px;">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th>
              <th>é–‹å§‹</th>
              <th>çµ‚äº†</th>
              <th>ä½œæ¥­</th>
              <th class="right">å°æ•°</th>
              <th>æ‹…å½“</th>
              <th>ãƒ¡ãƒ¢</th>
              <th class="right">æ™‚é–“</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th colspan="7" class="right">åˆè¨ˆ</th>
              <th class="right" id="totalCell">00:00:00</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="footer">â€» è¨˜éŒ²ã¯ã“ã®ç«¯æœ«ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚èª¤è¨ˆæ¸¬ã¯è¡Œå˜ä½ã§å‰Šé™¤ã§ãã¾ã™ã€‚</div>
    </section>
  </div>

  <script>
    // ---------- å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----------
    const $ = (sel) => document.querySelector(sel);
    const pad2 = (n) => String(n).padStart(2, '0');
    const fmtTime = (ms) => { const sec = Math.floor(ms / 1000); const h = Math.floor(sec / 3600); const m = Math.floor((sec % 3600) / 60); const s = sec % 60; return `${pad2(h)}:${pad2(m)}:${pad2(s)}`; };
    const ymd = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const hm = (d) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

    // ---------- ã‚¹ãƒ†ãƒ¼ãƒˆ ----------
    let state = { running:false, paused:false, startAt:null, pauseAccum:0, tickId:null };

    // ---------- ã‚¿ãƒ–åˆ‡æ›¿ ----------
    function showTab(tab){ const isSummary = tab === 'summary'; $('#panelTimer').style.display = isSummary ? 'none' : 'block'; $('#panelSummary').style.display = isSummary ? 'block' : 'none'; $('#tabTimerBtn').classList.toggle('active', !isSummary); $('#tabSummaryBtn').classList.toggle('active', isSummary); if(isSummary){ $('#datePick').value = ymd(new Date()); renderTableFor($('#datePick').value); } location.hash = isSummary ? '#summary' : '#timer'; }
    $('#tabTimerBtn').addEventListener('click', () => showTab('timer'));
    $('#tabSummaryBtn').addEventListener('click', () => showTab('summary'));
    window.addEventListener('hashchange', () => { if(location.hash === '#summary') showTab('summary'); else showTab('timer'); });

    // ---------- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ & ã‚¯ãƒ©ã‚¦ãƒ‰å¾…ã¡è¡Œåˆ—ï¼‰ ----------
    const LS_KEY = 'work_timer_logs_v1';
    const LS_PRESETS = 'task_presets_v1';
    function loadLogs(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch(e){ return {}; } }
    function saveLogs(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
    function pushLog(entry){
      const data = loadLogs();
      const key = entry.date; if(!data[key]) data[key] = [];
      data[key].push(entry);
      saveLogs(data);
      // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚é€ä¿¡ï¼ˆè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ï¼‰
      trySendToCloud(entry);
    }
    function getLogsByDate(dateStr){ const data = loadLogs(); return data[dateStr] || []; }
    function clearDate(dateStr){ const data = loadLogs(); delete data[dateStr]; saveLogs(data); }
    function deleteEntry(dateStr, idx){ const data = loadLogs(); if(!data[dateStr]) return; data[dateStr].splice(idx,1); if(data[dateStr].length===0) delete data[dateStr]; saveLogs(data); }

    // ---------- ãƒ—ãƒªã‚»ãƒƒãƒˆ ----------
    function loadPresets(){ try { return JSON.parse(localStorage.getItem(LS_PRESETS) || '[]'); } catch(e){ return []; } }
    function savePresets(list){ localStorage.setItem(LS_PRESETS, JSON.stringify(list)); }
    function renderPresets(){ const list = loadPresets(); const dl = $('#taskPresets'); dl.innerHTML = ''; list.forEach(v=>{ const o = document.createElement('option'); o.value = v; dl.appendChild(o); }); }
    function addPresetCurrent(){ const v = ($('#taskName').value||'').trim(); if(!v) return alert('ä½œæ¥­é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); const list = loadPresets(); if(!list.includes(v)){ list.push(v); list.sort((a,b)=>a.localeCompare(b,'ja')); savePresets(list); renderPresets(); alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ'); } else { alert('æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™'); } }

    // ---------- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º ----------
    function setStatus(text){ $('#statusLine').textContent = text; }
    function updateTimer(){ if(!state.running) return; const now = Date.now(); const elapsed = (now - state.startAt) + state.pauseAccum; $('#timerDisplay').textContent = fmtTime(elapsed); }
    function startTick(){ stopTick(); state.tickId = setInterval(updateTimer, 250); }
    function stopTick(){ if(state.tickId){ clearInterval(state.tickId); state.tickId = null; } }

    // ---------- å…¥åŠ›è£œåŠ© ----------
    const workerInput = $('#worker');
    const savedWorker = localStorage.getItem('default_worker');
    if(savedWorker) workerInput.value = savedWorker;
    $('#btnAddPreset').addEventListener('click', addPresetCurrent);

    // ---------- ãƒœã‚¿ãƒ³å‹•ä½œ ----------
    $('#btnStart').addEventListener('click', () => {
      const task = $('#taskName').value.trim();
      const amount = Number($('#taskAmount').value || 0);
      const worker = workerInput.value.trim();
      if(!task) return alert('ä½œæ¥­é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if(!worker) return alert('æ‹…å½“è€…ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      localStorage.setItem('default_worker', worker);
      state = { running:true, paused:false, startAt:Date.now(), pauseAccum:0, tickId:null };
      startTick(); updateTimer();
      $('#btnStart').style.display = 'none'; $('#btnPause').style.display = 'inline-block'; $('#btnResume').style.display = 'none'; $('#btnFinish').style.display = 'inline-block'; $('#btnReset').style.display = 'inline-block';
      setStatus('è¨ˆæ¸¬ä¸­â€¦');
    });

    $('#btnPause').addEventListener('click', () => { if(!state.running || state.paused) return; state.paused = true; state.pausePoint = Date.now(); stopTick(); $('#btnPause').style.display = 'none'; $('#btnResume').style.display = 'inline-block'; setStatus('ä¸€æ™‚åœæ­¢ä¸­'); });
    $('#btnResume').addEventListener('click', () => { if(!state.running || !state.paused) return; const now = Date.now(); state.pauseAccum += (now - state.pausePoint); state.paused = false; startTick(); updateTimer(); $('#btnPause').style.display = 'inline-block'; $('#btnResume').style.display = 'none'; setStatus('è¨ˆæ¸¬ä¸­â€¦'); });

    $('#btnFinish').addEventListener('click', () => {
      if(!state.running) return;
      stopTick();
      const endAt = Date.now();
      const task = $('#taskName').value.trim();
      const amount = Number($('#taskAmount').value || 0);
      const worker = workerInput.value.trim();
      const notes = $('#notes').value.trim();
      const elapsed = (endAt - state.startAt) + state.pauseAccum - (state.paused ? (endAt - state.pausePoint) : 0);
      const startDate = new Date(state.startAt);
      const endDate = new Date(endAt);
      const entry = { date: ymd(startDate), start: startDate.toISOString(), end: endDate.toISOString(), task, amount, worker, notes, durationMs: Math.max(elapsed, 0) };
      pushLog(entry);
      $('#timerDisplay').textContent = fmtTime(entry.durationMs);
      setStatus(`ä¿å­˜ã—ã¾ã—ãŸï¼ˆ${hm(startDate)} â†’ ${hm(endDate)} / ${fmtTime(entry.durationMs)}ï¼‰`);
      state = { running:false, paused:false, startAt:null, pauseAccum:0, tickId:null };
      $('#btnStart').style.display = 'inline-block'; $('#btnPause').style.display = 'none'; $('#btnResume').style.display = 'none'; $('#btnFinish').style.display = 'none'; $('#btnReset').style.display = 'none';
      alert('ä½œæ¥­ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    $('#btnReset').addEventListener('click', () => { if(confirm('è¨ˆæ¸¬ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')){ stopTick(); state = { running:false, paused:false, startAt:null, pauseAccum:0, tickId:null }; $('#timerDisplay').textContent = '00:00:00'; setStatus('å¾…æ©Ÿä¸­'); $('#btnStart').style.display = 'inline-block'; $('#btnPause').style.display = 'none'; $('#btnResume').style.display = 'none'; $('#btnFinish').style.display = 'none'; $('#btnReset').style.display = 'none'; } });

    // ---------- ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ ----------
    const QUEUE_KEY = 'work_timer_cloud_queue_v1';
    function loadQueue(){ try { return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); } catch(e){ return []; } }
    function saveQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); }
    function enqueue(entry){ const q = loadQueue(); q.push(entry); saveQueue(q); }

    async function sendToCloud(entry){
      if(!CLOUD_ENDPOINT || !CLOUD_TOKEN) return; // æœªè¨­å®šãªã‚‰ä½•ã‚‚ã—ãªã„
      const url = `${CLOUD_ENDPOINT}?token=${encodeURIComponent(CLOUD_TOKEN)}`;
      const payload = { ...entry, clientUrl: location.href, clientTZ: Intl.DateTimeFormat().resolvedOptions().timeZone };
      const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error('cloud-post-failed');
      return true;
    }

    async function trySendToCloud(entry){
      try { await sendToCloud(entry); }
      catch(err){ enqueue(entry); }
    }

    async function flushQueue(){
      if(!CLOUD_ENDPOINT || !CLOUD_TOKEN) return;
      const q = loadQueue(); if(!q.length) return;
      const remain = [];
      for(const item of q){
        try { await sendToCloud(item); }
        catch(e){ remain.push(item); }
      }
      saveQueue(remain);
    }
    window.addEventListener('online', flushQueue);

    // ---------- é›†è¨ˆ ----------
    function renderTableFor(dateStr){
      const rows = getLogsByDate(dateStr);
      const tbody = $('#tbl tbody');
      tbody.innerHTML = '';
      let total = 0;
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const s = new Date(r.start); const e = new Date(r.end);
        total += (r.durationMs||0);
        tr.innerHTML = `
          <td class="right">${idx+1}</td>
          <td>${hm(s)}</td>
          <td>${hm(e)}</td>
          <td>${escapeHtml(r.task||'')}</td>
          <td class="right">${Number(r.amount||0)}</td>
          <td>${escapeHtml(r.worker||'')}</td>
          <td>${escapeHtml(r.notes||'')}</td>
          <td class="right"><span class="pill">${fmtTime(r.durationMs||0)}</span></td>
          <td><button class="danger" data-idx="${idx}">å‰Šé™¤</button></td>
        `;
        tbody.appendChild(tr);
      });
      $('#totalCell').textContent = fmtTime(total);

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
      tbody.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          const i = Number(e.currentTarget.getAttribute('data-idx'));
          if(confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
            deleteEntry(dateStr, i);
            renderTableFor(dateStr);
          }
        });
      });
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    $('#datePick').addEventListener('change', (e)=>{ renderTableFor(e.target.value); });
    $('#btnCsv').addEventListener('click', () => { const dateStr = $('#datePick').value || ymd(new Date()); const rows = getLogsByDate(dateStr); const head = ['date','start','end','task','amount','worker','notes','durationSec']; const lines = [head.join(',')]; for(const r of rows){ const durationSec = Math.round((r.durationMs||0)/1000); const csvRow = [r.date, r.start, r.end, q(r.task), r.amount, q(r.worker), q(r.notes), durationSec].join(','); lines.push(csvRow);} const blob = new Blob(["\uFEFF"+lines.join('\n')], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `work_logs_${dateStr}.csv`; a.click(); URL.revokeObjectURL(a.href); });
    $('#btnClearDay').addEventListener('click', () => { const dateStr = $('#datePick').value || ymd(new Date()); if(confirm(`${dateStr} ã®è¨˜éŒ²ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)){ clearDate(dateStr); renderTableFor(dateStr);} });
    function q(v){ const s = String(v==null?'':v); return '"' + s.replace(/"/g,'""') + '"'; }

    // ---------- åˆæœŸè¡¨ç¤º ----------
    (function init(){ if(location.hash === '#summary') showTab('summary'); else showTab('timer'); renderPresets(); })();
  </script>
</body>
</html>
